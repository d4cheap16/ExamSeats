<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç›£è€ƒç³»çµ± (Exam Monitor)</title>
    
    <!-- è¼‰å…¥ Tailwind CSS (æ¨£å¼) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- è¼‰å…¥ React å’Œ Babel (æ ¸å¿ƒé‹ç®—) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- è¼‰å…¥ Lucide Icons (åœ–ç¤º) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- è‡ªå®šç¾©æ¨£å¼ -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', monospace; }
        .pixel-border {
            box-shadow: 4px 4px 0px 0px rgba(0,0,0,0.3);
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        /* éš±è— number input çš„ä¸Šä¸‹ç®­é ­ */
        input[type=number]::-webkit-outer-spin-button,
        input[type=number]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        /* æ—¥æœŸé¸æ“‡å™¨æ¨£å¼å„ªåŒ– */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }
        /* ç¼ºè€ƒåŸå› ä¸‹æ‹‰é¸å–®æ¨£å¼ - æ”¹ç‚ºç™½åº•é»‘å­— */
        .reason-select {
            appearance: none;
            background-color: white; 
            color: black;
            border: 2px solid rgba(0,0,0,0.2);
            text-align: center;
            font-size: 0.75rem;
            font-weight: 900;
            cursor: pointer;
            padding: 2px 12px 2px 6px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            /* ç®­é ­æ”¹ç‚ºé»‘è‰² */
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='black' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0px center;
            background-repeat: no-repeat;
            background-size: 1.2em 1.2em;
        }
        .reason-select:hover {
            background-color: #f3f4f6; /* gray-100 */
        }
        .reason-select:focus {
            outline: none;
            border-color: #2563eb;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 h-screen w-screen overflow-hidden">
    <div id="root" class="h-full w-full"></div>

    <!-- ä¸»ç¨‹å¼é‚è¼¯ -->
    <script type="text/babel" data-type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection, getDocs } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        // ==========================================
        // â–¼ æ‚¨çš„ Firebase Config â–¼
        // ==========================================
        const firebaseConfig = {
          apiKey: "AIzaSyBd1OUQ2wwEOSIezzhsuuYcjZSXJPn-WnI",
          authDomain: "examseat-508e9.firebaseapp.com",
          projectId: "examseat-508e9",
          storageBucket: "examseat-508e9.firebasestorage.app",
          messagingSenderId: "959964513566",
          appId: "1:959964513566:web:88dac9c40c5993a90a750f"
        };
        // ==========================================

        const isFirebaseConfigured = firebaseConfig.apiKey && firebaseConfig.projectId;
        let app, auth, db;
        if (isFirebaseConfigured) {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        }

        const { useState, useEffect, useRef, useMemo } = React;

        const Icon = ({ name, size = 24, className = "" }) => {
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        // --- Constants ---
        // ç®¡ç†å“¡å¯†ç¢¼é›œæ¹Š (Makima777)
        const ADMIN_HASH = "667d3b4405324cb53a755b5eb6c0d5370322527a32f75964d9a040230d273033";
        
        // ç¼ºè€ƒåŸå› é¸é …
        const ABSENCE_REASONS = ["ç¼ºè€ƒ", "ç—…å‡", "äº‹å‡", "å…¬å‡", "å–ªå‡", "æŠ½é›¢"];

        const DEFAULT_SCHEDULE = [
            { time: '08:10-09:20', subject: 'æ•¸å­¸ä¹™' },
            { time: '09:35-10:35', subject: 'è‡ªç¿’' },
            { time: '10:50-12:00', subject: 'æ­·å²' },
            { time: '13:20-14:30', subject: 'åœ°ç†' },
            { time: '14:45-15:45', subject: 'è‡ªç¿’' },
            { time: '16:00-17:10', subject: 'å…¬æ°‘' },
        ];

        const DEFAULT_ROSTER = `1\tå‘¨æ©ä½‘\n2\tæ—å®ç‡\n3\tæ—æ©æˆ\n4\tæ—æ™‰è‘³\n5\tæ—æ¢“è»’\n6\té‡‘å°‘æ¾¤\n7\tæ¢å®¶æ©\n8\tæ¢é–æ˜Œ\n9\tè¨±å­å¯¬\n10\té™³å“\n11\té™³è—æ–‡\n12\tå½­å‡±æ¯…\n13\tæ¥Šé–é©›\n14\tåŠ‰äº­é ¡\n15\tæ½˜è‚²å“²\n16\tæº«é›æ™´\n17\tç‹è‹¡æ©\n18\tç‹è©®å„€\n19\tå¤å¦®é‘«\n20\tå‘æ˜ æŸ”\n21\tæœ±æ´§ç”„\n22\tå³æ€è«­\n23\tå³ç¦¹è±\n24\tå³ç®å¦¤\n25\tæè© æ¬£\n26\tæèŠ¯ç‘€\n27\tæ—ä¼½ç’‡\n28\tæ—ç³\n29\tèƒ¡æ ¼ç‘„\n30\tå¼µæ²›æ–‡\n31\tå¾èŠ·èŠ¸\n32\tæ›¾è‹¥åº­\n33\tç«¥å®‡å²‘\n34\té»ƒå¿ƒç‘€\n35\tæ¥Šé‡‡é‘«\n36\tæ¥Šå“æ­†\n37\té»å®¹ç‘„\n38\tè—æ¢“ç‘œ\n39\tæ—èŠ³ä»”\n40\tè”£ä½©èŠ¸\n41\té­ç‘œå»·`;

        // --- Helpers ---
        const formatDate = (dateStr) => {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            return `${date.getFullYear()}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')} (${days[date.getDay()]})`;
        };

        const getTodayString = () => {
            const d = new Date();
            return `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, '0')}-${d.getDate().toString().padStart(2, '0')}`;
        };

        // SHA-256 Hashing Function
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // --- Components ---

        // ç®¡ç†è€…å¾Œå°
        const AdminPanel = ({ onBack, onEnterClass }) => {
            const [classList, setClassList] = useState([]);
            const [loading, setLoading] = useState(true);

            const fetchClasses = async () => {
                if (!db) return;
                try {
                    const querySnapshot = await getDocs(collection(db, "classrooms"));
                    const list = [];
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        list.push({
                            id: doc.id,
                            lastUpdated: data.lastUpdated ? new Date(data.lastUpdated).toLocaleString() : 'æœªçŸ¥',
                            ...data
                        });
                    });
                    list.sort((a, b) => new Date(b.lastUpdated || 0) - new Date(a.lastUpdated || 0));
                    setClassList(list);
                } catch (error) {
                    console.error("è®€å–å¤±æ•—:", error);
                    alert("è®€å–å¤±æ•—ï¼Œè«‹ç¢ºèªè³‡æ–™åº«æ¬Šé™è¨­å®šã€‚");
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => { fetchClasses(); }, []);

            const handleDelete = async (id) => {
                if (confirm(`ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤ç­ç´šã€Œ${id}ã€å—ï¼Ÿ`)) {
                    try {
                        await deleteDoc(doc(db, "classrooms", id));
                        setClassList(prev => prev.filter(c => c.id !== id));
                    } catch (error) { alert("åˆªé™¤å¤±æ•—"); }
                }
            };

            return (
                <div className="flex flex-col items-center min-h-screen bg-slate-900 text-slate-100 p-4 font-mono">
                    <div className="w-full max-w-4xl">
                        <div className="flex justify-between items-center mb-6 bg-red-900/50 p-4 rounded-xl border-l-4 border-red-500">
                            <div className="flex items-center gap-3">
                                <div className="p-2 bg-red-600 rounded-lg shadow-lg"><Icon name="shield-alert" size={32} className="text-white" /></div>
                                <div><h1 className="text-2xl font-black tracking-widest text-white">ADMIN DASHBOARD</h1><p className="text-red-200 text-sm">ç³»çµ±ç®¡ç†ä»‹é¢</p></div>
                            </div>
                            <button onClick={onBack} className="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg flex items-center gap-2 font-bold transition-all"><Icon name="log-out" size={18} /> ç™»å‡º</button>
                        </div>
                        <div className="bg-slate-800 rounded-xl pixel-border border-4 border-gray-700 overflow-hidden shadow-2xl">
                            <div className="p-4 border-b-2 border-gray-700 flex justify-between items-center bg-slate-750">
                                <h2 className="font-bold text-lg flex items-center gap-2"><Icon name="list" /> ç­ç´šåˆ—è¡¨ ({classList.length})</h2>
                                <button onClick={fetchClasses} className="p-2 hover:bg-slate-600 rounded-full"><Icon name="refresh-cw" size={18} /></button>
                            </div>
                            {loading ? (
                                <div className="p-8 text-center text-gray-400 flex flex-col items-center gap-2"><Icon name="loader-2" className="animate-spin" size={32} />è®€å–ä¸­...</div>
                            ) : classList.length === 0 ? (
                                <div className="p-8 text-center text-gray-500">ç„¡ç­ç´šè³‡æ–™</div>
                            ) : (
                                <div className="max-h-[70vh] overflow-y-auto custom-scrollbar">
                                    <table className="w-full text-left border-collapse">
                                        <thead className="bg-slate-900 text-gray-400 sticky top-0 z-10 shadow-md"><tr><th className="p-4 font-bold">ç­ç´šä»£ç¢¼</th><th className="p-4 font-bold hidden md:table-cell">é¡¯ç¤ºåç¨±</th><th className="p-4 font-bold hidden sm:table-cell">æœ€å¾Œæ›´æ–°</th><th className="p-4 font-bold text-right">æ“ä½œ</th></tr></thead>
                                        <tbody className="divide-y divide-gray-700">
                                            {classList.map(cls => (
                                                <tr key={cls.id} className="hover:bg-slate-700/50 transition-colors">
                                                    <td className="p-4 font-bold text-yellow-400 font-mono text-lg">{cls.id}</td>
                                                    <td className="p-4 text-gray-300 hidden md:table-cell">{cls.config?.systemTitle || '-'}</td>
                                                    <td className="p-4 text-gray-500 text-sm hidden sm:table-cell">{cls.lastUpdated}</td>
                                                    <td className="p-4 text-right space-x-2">
                                                        <button onClick={() => onEnterClass(cls.id)} className="inline-flex items-center gap-1 px-3 py-1 bg-blue-600 hover:bg-blue-500 text-white rounded text-sm font-bold"><Icon name="log-in" size={14} /> é€²å…¥</button>
                                                        <button onClick={() => handleDelete(cls.id)} className="inline-flex items-center gap-1 px-3 py-1 bg-red-600 hover:bg-red-500 text-white rounded text-sm font-bold"><Icon name="trash-2" size={14} /> åˆªé™¤</button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // ç™»å…¥å…ƒä»¶
        const LoginScreen = ({ onLogin, onAdminLogin }) => {
            const [input, setInput] = useState('');
            const [error, setError] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                const code = input.trim();
                if (!code) { setError('è«‹è¼¸å…¥ç­ç´šåç¨±'); return; }
                
                // å¯†ç¢¼é©—è­‰ (SHA-256)
                const hash = await sha256(code);
                if (hash === ADMIN_HASH) {
                    onAdminLogin();
                    return;
                }

                if (!/^[a-zA-Z0-9_\u4e00-\u9fa5]+$/.test(code)) {
                    setError('ç­ç´šåç¨±åªèƒ½åŒ…å«ä¸­æ–‡ã€è‹±æ–‡ã€æ•¸å­—æˆ–åº•ç·š');
                    return;
                }
                onLogin(code);
            };

            return (
                <div className="flex flex-col items-center justify-center min-h-screen bg-slate-900 text-slate-100 p-4 select-none">
                    <div className="bg-slate-800 p-8 rounded-xl pixel-border border-4 border-gray-700 w-full max-w-md text-center shadow-2xl">
                        <div className="flex justify-center mb-6"><div className="p-4 bg-yellow-400 rounded-full border-4 border-yellow-600 shadow-lg"><Icon name="school" size={48} className="text-yellow-900" /></div></div>
                        <h1 className="text-3xl font-black tracking-widest text-white mb-2">SUPER EXAM SYSTEM</h1>
                        <p className="text-gray-400 mb-8 text-sm">è«‹è¼¸å…¥ç­ç´šåç¨±ä»¥å»ºç«‹è€ƒå ´</p>
                        <form onSubmit={handleSubmit} className="flex flex-col gap-4">
                            <div className="relative">
                                <Icon name="key" size={20} className="absolute left-3 top-3 text-gray-500" />
                                <input type="text" value={input} onChange={(e) => {setInput(e.target.value); setError('');}} placeholder="ä¾‹å¦‚ï¼šClass302 æˆ– TeacherWang" className="w-full bg-slate-700 border-2 border-slate-600 rounded-lg py-3 pl-10 pr-4 text-white placeholder-gray-500 focus:outline-none focus:border-blue-500 focus:bg-slate-600 transition-colors text-lg font-bold select-text" autoFocus />
                            </div>
                            {error && <p className="text-red-400 text-sm font-bold animate-pulse">{error}</p>}
                            <button type="submit" className="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg border-b-4 border-blue-800 active:border-b-0 active:translate-y-1 transition-all flex items-center justify-center gap-2 mt-2"><Icon name="log-in" size={20} /> é€²å…¥è€ƒå ´</button>
                        </form>
                        <div className="mt-8 text-xs text-gray-500 border-t border-gray-700 pt-4"><p>ğŸ’¡ æç¤ºï¼šè¼¸å…¥ç›¸åŒçš„ä»£ç¢¼å³å¯åœ¨ä¸åŒé›»è…¦åŒæ­¥è³‡æ–™ã€‚</p></div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [syncStatus, setSyncStatus] = useState('idle');
            const [currentTime, setCurrentTime] = useState(new Date());
            const [mode, setMode] = useState('edit');
            const [config, setConfig] = useState({ rows: 5, cols: 7, date: getTodayString(), systemTitle: '' });
            const [schedule, setSchedule] = useState(DEFAULT_SCHEDULE);
            const [rosterText, setRosterText] = useState(DEFAULT_ROSTER);
            const [rosterMap, setRosterMap] = useState({});
            const [csvUrl, setCsvUrl] = useState('');
            const [seats, setSeats] = useState({});
            const [showSettings, setShowSettings] = useState(false);
            const [activeClassroom, setActiveClassroom] = useState(null);
            const [isAdminMode, setIsAdminMode] = useState(false);
            const inputRefs = useRef({});

            const duplicateNumbers = useMemo(() => {
                const counts = {};
                Object.values(seats).forEach(s => { if (s.number) counts[s.number] = (counts[s.number] || 0) + 1; });
                return new Set(Object.keys(counts).filter(n => counts[n] > 1));
            }, [seats]);

            useEffect(() => {
                if (!isFirebaseConfigured) { setSyncStatus('not-configured'); return; }
                signInAnonymously(auth).catch((error) => { console.error("Auth Error", error); setSyncStatus('error'); });
                const unsubscribe = onAuthStateChanged(auth, setUser);
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!isFirebaseConfigured || !user || !activeClassroom) {
                    if (!activeClassroom) return;
                    const savedLocal = localStorage.getItem(`examMonitorData_${activeClassroom}`);
                    if (savedLocal) {
                        try {
                            const parsed = JSON.parse(savedLocal);
                            let dateVal = parsed.config?.date || getTodayString();
                            if (parsed.config && !parsed.config.date && parsed.config.title) dateVal = getTodayString();
                            if (parsed.config) setConfig(prev => ({...prev, ...parsed.config, date: dateVal}));
                            if (parsed.schedule) setSchedule(parsed.schedule);
                            if (parsed.rosterText) setRosterText(parsed.rosterText);
                            if (parsed.seats) setSeats(parsed.seats);
                        } catch(e) {}
                    }
                    return;
                }
                setSyncStatus('loading');
                const docRef = doc(db, 'classrooms', activeClassroom);
                const unsubscribe = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        let dateVal = data.config?.date || getTodayString();
                        if (data.config) setConfig(prev => ({...prev, ...data.config, date: dateVal}));
                        if (data.schedule) setSchedule(data.schedule);
                        if (data.rosterText) setRosterText(data.rosterText);
                        if (data.seats) setSeats(data.seats);
                        if (data.csvUrl) setCsvUrl(data.csvUrl);
                        setSyncStatus('idle');
                    } else {
                        const savedLocal = localStorage.getItem(`examMonitorData_${activeClassroom}`);
                        if (savedLocal) {
                            try {
                                const parsed = JSON.parse(savedLocal);
                                setConfig(prev => ({...prev, ...(parsed.config || {})}));
                                setSchedule(prev => parsed.schedule || prev);
                                setRosterText(prev => parsed.rosterText || prev);
                                setSeats(prev => parsed.seats || prev);
                            } catch(e){}
                        }
                        setSyncStatus('idle');
                    }
                }, (error) => { console.error("Sync error", error); setSyncStatus('error'); });
                return () => unsubscribe();
            }, [user, activeClassroom]);

            useEffect(() => {
                const lines = rosterText.split('\n');
                const newMap = {};
                lines.forEach(line => { const parts = line.trim().split(/[\t,ï¼Œ\s]+/); if (parts.length >= 2) newMap[parts[0]] = parts[1]; });
                setRosterMap(newMap);
            }, [rosterText]);

            useEffect(() => {
                const timer = setInterval(() => setCurrentTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);

            const saveToCloud = async () => {
                if (!activeClassroom) return;
                localStorage.setItem(`examMonitorData_${activeClassroom}`, JSON.stringify({ config, schedule, rosterText, seats }));
                if (!isFirebaseConfigured || !user) { alert('å·²å„²å­˜è‡³æœ¬åœ° (æœªè¨­å®š Firebase)'); return; }
                setSyncStatus('saving');
                try {
                    const docRef = doc(db, 'classrooms', activeClassroom);
                    await setDoc(docRef, { config, schedule, rosterText, seats, csvUrl, lastUpdated: new Date().toISOString(), updatedBy: user.uid });
                    setSyncStatus('saved');
                    setTimeout(() => setSyncStatus('idle'), 2000);
                } catch (e) { console.error(e); setSyncStatus('error'); alert('é›²ç«¯å„²å­˜å¤±æ•—ï¼Œå·²å­˜è‡³æœ¬åœ°'); }
            };

            const deleteClassroomData = async () => {
                if (!activeClassroom) return;
                const confirmCode = prompt(`è­¦å‘Šï¼šé€™å°‡æœƒæ°¸ä¹…åˆªé™¤ã€Œ${activeClassroom}ã€çš„æ‰€æœ‰è³‡æ–™ï¼\n\nè«‹è¼¸å…¥ã€Œ${activeClassroom}ã€ä»¥ç¢ºèªï¼š`);
                if (confirmCode === activeClassroom) {
                    try {
                        setSyncStatus('saving');
                        if (isFirebaseConfigured && user) await deleteDoc(doc(db, 'classrooms', activeClassroom));
                        localStorage.removeItem(`examMonitorData_${activeClassroom}`);
                        alert('è³‡æ–™å·²åˆªé™¤ã€‚');
                        setSchedule(DEFAULT_SCHEDULE); setSeats({}); setRosterText(DEFAULT_ROSTER); setActiveClassroom(null);
                    } catch (e) { console.error(e); alert('åˆªé™¤å¤±æ•—'); setSyncStatus('error'); }
                }
            };

            const handleCsvImport = async () => {
                if (!csvUrl) return;
                try {
                    setSyncStatus('loading');
                    const response = await fetch(csvUrl);
                    const text = await response.text();
                    setRosterText(text);
                    setSyncStatus('idle');
                    alert('åŒ¯å…¥æˆåŠŸï¼');
                } catch (e) { alert('åŒ¯å…¥å¤±æ•—ã€‚'); setSyncStatus('error'); }
            };

            const toggleFullScreen = () => {
                if (!document.fullscreenElement) document.documentElement.requestFullscreen();
                else if (document.exitFullscreen) document.exitFullscreen();
            };

            const isCurrentSubject = (timeRange) => {
                const now = new Date();
                const currentMinutes = now.getHours() * 60 + now.getMinutes();
                const [start, end] = timeRange.split('-');
                if (!start || !end) return false;
                const [startH, startM] = start.split(':').map(Number);
                const [endH, endM] = end.split(':').map(Number);
                return currentMinutes >= (startH * 60 + startM) && currentMinutes <= (endH * 60 + endM);
            };

            const stats = (() => {
                let shouldAttend = 0, actualAttend = 0, absentList = [];
                Object.values(seats).forEach(seat => {
                    if (seat.number) {
                        shouldAttend++;
                        if (seat.status !== 'absent') actualAttend++;
                        else {
                            const name = rosterMap[seat.number] || '';
                            const reason = seat.reason || 'ç¼ºè€ƒ'; // ä½¿ç”¨å„²å­˜çš„åŸå› æˆ–é è¨­
                            absentList.push({
                                text: `${seat.number} ${name}`,
                                reason: reason,
                                num: parseInt(seat.number) || 0
                            });
                        }
                    }
                });
                absentList.sort((a, b) => a.num - b.num);
                return { shouldAttend, actualAttend, absentList };
            })();

            const updateSeatNumber = (r, c, val) => {
                const key = `${r}-${c}`;
                setSeats(prev => ({ ...prev, [key]: { ...prev[key], number: val, status: val ? 'present' : 'empty' } }));
            };

            const toggleSeatStatus = (r, c) => {
                const key = `${r}-${c}`;
                const current = seats[key];
                if (!current || !current.number) return;
                
                // åˆ‡æ›é‚è¼¯ï¼šå‡ºå¸­ <-> ç¼ºå¸­(é è¨­ç¼ºè€ƒ)
                const newStatus = current.status === 'present' ? 'absent' : 'present';
                const newReason = newStatus === 'absent' ? 'ç¼ºè€ƒ' : undefined; // é‡ç½®åŸå› 
                
                setSeats(prev => ({
                    ...prev,
                    [key]: { ...current, status: newStatus, reason: newReason }
                }));
            };

            // æ›´æ–°ç¼ºè€ƒåŸå› 
            const updateSeatReason = (r, c, newReason) => {
                const key = `${r}-${c}`;
                setSeats(prev => ({
                    ...prev,
                    [key]: { ...prev[key], reason: newReason }
                }));
            };

            const handleDeleteSchedule = (idx) => { if (window.confirm('åˆªé™¤æ­¤è€ƒç¨‹ï¼Ÿ')) setSchedule(schedule.filter((_, i) => i !== idx)); };

            const handleKeyDown = (e, r, c) => {
                let targetR = r; let targetC = c;
                if (e.key === 'ArrowUp') targetR = Math.max(0, r - 1);
                else if (e.key === 'ArrowDown') targetR = Math.min(config.rows - 1, r + 1);
                else if (e.key === 'ArrowLeft') targetC = Math.max(0, c - 1);
                else if (e.key === 'ArrowRight') targetC = Math.min(config.cols - 1, c + 1);
                else return;
                const targetKey = `${targetR}-${targetC}`;
                if (inputRefs.current[targetKey]) { e.preventDefault(); inputRefs.current[targetKey].focus(); }
            };

            if (isAdminMode) return <AdminPanel onBack={() => setIsAdminMode(false)} onEnterClass={(id) => { setIsAdminMode(false); setActiveClassroom(id); }} />;
            if (!activeClassroom) return <LoginScreen onLogin={setActiveClassroom} onAdminLogin={() => setIsAdminMode(true)} />;

            return (
                <div className="h-screen w-screen flex flex-col bg-slate-900 text-slate-100 overflow-hidden font-mono select-none">
                    {/* Navbar */}
                    <div className="shrink-0 w-full bg-gray-300 text-gray-800 p-2 flex justify-between items-center border-b-4 border-gray-400 shadow-lg z-20 relative">
                        <div className="flex items-center gap-4">
                            <div className="flex gap-1 ml-2"><div className="w-3 h-3 rounded-full bg-red-500 animate-pulse"></div><div className="w-3 h-3 rounded-full bg-yellow-500"></div><div className="w-3 h-3 rounded-full bg-green-500"></div></div>
                            {mode === 'edit' ? (
                                <input type="text" className="font-black text-xl tracking-widest text-gray-700 bg-transparent border-b-2 border-gray-500 outline-none hidden md:block placeholder-gray-400 w-64 select-text" value={config.systemTitle || ''} placeholder="è«‹è¼¸å…¥ç­ç´šåç¨±" onChange={(e) => setConfig({...config, systemTitle: e.target.value})} />
                            ) : (
                                <span className="font-black text-xl tracking-widest text-gray-600 hidden md:block">{config.systemTitle || activeClassroom || 'ç­ç´šåç¨±'}</span>
                            )}
                            <button onClick={saveToCloud} disabled={syncStatus === 'saving'} className={`flex items-center gap-2 px-3 py-1 rounded-full border-inner shadow-inner transition-colors ${syncStatus === 'saved' ? 'bg-green-100' : 'bg-gray-200 hover:bg-gray-300'}`} title="æ‰‹å‹•å„²å­˜">
                                {syncStatus === 'loading' ? <Icon name="refresh-cw" className="animate-spin text-blue-500" size={14} /> : syncStatus === 'saving' ? <Icon name="cloud-upload" className="animate-bounce text-blue-500" size={14} /> : syncStatus === 'saved' ? <Icon name="check" className="text-green-600" size={14} /> : syncStatus === 'error' ? <Icon name="cloud-off" className="text-red-500" size={14} /> : syncStatus === 'not-configured' ? <Icon name="alert-circle" className="text-orange-500" size={14} /> : <Icon name="save" className="text-gray-600" size={14} />}
                                <span className={`text-xs font-bold ${syncStatus === 'saved' ? 'text-green-700' : 'text-gray-600'}`}>{syncStatus === 'loading' ? 'è®€å–...' : syncStatus === 'saving' ? 'å„²å­˜ä¸­...' : syncStatus === 'saved' ? 'å·²å„²å­˜' : syncStatus === 'error' ? 'å¤±æ•—' : syncStatus === 'not-configured' ? 'æœªè¨­å®š' : 'é»æ­¤å­˜æª”'}</span>
                            </button>
                        </div>
                        <div className="flex gap-2">
                            <div className="flex bg-gray-200 p-1 rounded-lg shadow-inner border border-gray-400">
                                <button onClick={() => setMode('edit')} className={`px-4 py-1.5 rounded font-bold flex items-center gap-2 text-sm transition-all ${mode === 'edit' ? 'bg-yellow-400 text-yellow-900 shadow-md' : 'text-gray-500 hover:text-gray-700'}`}><Icon name="settings" size={16} /> ç·¨è¼¯</button>
                                <button onClick={() => setMode('view')} className={`px-4 py-1.5 rounded font-bold flex items-center gap-2 text-sm transition-all ${mode === 'view' ? 'bg-blue-500 text-white shadow-md' : 'text-gray-500 hover:text-gray-700'}`}><Icon name="monitor" size={16} /> ç›£è€ƒ</button>
                            </div>
                            <button onClick={toggleFullScreen} className="px-3 py-1.5 bg-gray-700 text-white rounded-lg font-bold border-b-4 border-gray-900 active:border-b-0 active:translate-y-1 transition-all flex items-center gap-2 text-sm"><Icon name="maximize" size={16} /> å…¨è¢å¹•</button>
                            <button onClick={() => setShowSettings(true)} className="px-3 py-1.5 bg-gray-200 text-gray-600 rounded-lg border-b-4 border-gray-400 hover:bg-white active:border-b-0 active:translate-y-1 flex items-center gap-1 text-sm"><Icon name="settings" size={16} /> è¨­å®š</button>
                            <button onClick={() => setActiveClassroom(null)} className="px-3 py-1.5 bg-red-500 text-white rounded-lg font-bold border-b-4 border-red-700 hover:bg-red-400 active:border-b-0 active:translate-y-1 text-sm flex items-center" title="ç™»å‡º"><Icon name="log-out" size={16} /></button>
                        </div>
                    </div>

                    {/* Main Content */}
                    <div className="flex-1 flex w-full overflow-hidden relative p-4 gap-4">
                        {/* Left Section */}
                        <div className="flex-1 bg-slate-800 rounded-xl p-2 md:p-4 pixel-border relative flex flex-col border-4 border-gray-700 overflow-hidden">
                            <div className="w-full grid grid-cols-3 gap-4 mb-2 shrink-0 h-24">
                                {/* Date & Clock */}
                                <div className="bg-indigo-900 rounded-lg border-b-8 border-indigo-950 shadow-lg flex flex-col justify-center px-4 text-white relative overflow-hidden border border-indigo-700">
                                    <div className="absolute inset-0 bg-gradient-to-b from-transparent via-white/5 to-transparent opacity-20 pointer-events-none" style={{backgroundSize: '100% 4px'}}></div>
                                    <div className="flex items-center justify-between gap-4">
                                        <div className="flex flex-col items-start"><div className="text-xs text-indigo-300 mb-0.5">DATE</div>{mode === 'edit' ? (<input type="date" className="bg-white text-indigo-900 text-lg font-bold rounded px-2 py-0.5 outline-none border-2 border-indigo-400 select-text cursor-pointer" value={config.date} onChange={(e) => setConfig({...config, date: e.target.value})} />) : (<div className="text-lg md:text-xl font-bold text-white tracking-wide whitespace-nowrap">{formatDate(config.date)}</div>)}</div>
                                        <div className="flex flex-col items-end"><div className="text-xs text-indigo-300 mb-0.5">TIME</div><div className="text-3xl md:text-5xl font-black tabular-nums tracking-tight text-cyan-300 drop-shadow-[0_0_8px_rgba(103,232,249,0.6)] leading-none">{currentTime.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false })}</div></div>
                                    </div>
                                    <div className="w-full h-1 bg-gray-700 mt-2 rounded-full overflow-hidden opacity-50"><div className="h-full bg-cyan-400 transition-all duration-1000 ease-linear" style={{ width: `${(currentTime.getSeconds() / 60) * 100}%` }}></div></div>
                                </div>
                                {/* Podium */}
                                <div className="bg-amber-700 text-amber-100 rounded-lg border-b-8 border-amber-900 shadow-lg flex flex-col items-center justify-center relative overflow-hidden group"><div className="absolute top-2 left-3 opacity-30"><Icon name="monitor" size={32}/></div><div className="text-xs md:text-sm opacity-75">PODIUM</div><div className="font-bold text-3xl tracking-[0.5em] ml-4">è¬› å°</div></div>
                                <div className="invisible"></div>
                            </div>

                            {/* Seat Grid */}
                            <div className="flex-1 w-full h-full pt-2 pb-2">
                                <div className="grid gap-2 h-full w-full" style={{ gridTemplateColumns: `repeat(${config.cols}, 1fr)`, gridTemplateRows: `repeat(${config.rows}, 1fr)` }}>
                                    {Array.from({ length: config.rows }).map((_, r) => (
                                        Array.from({ length: config.cols }).map((_, c) => {
                                            const key = `${r}-${c}`;
                                            const seat = seats[key] || { number: '', status: 'empty' };
                                            const studentName = rosterMap[seat.number] || '';
                                            const isAbsent = seat.status === 'absent';
                                            const isDuplicate = seat.number && duplicateNumbers.has(seat.number);

                                            return (
                                                <div key={key} onClick={() => mode === 'view' && toggleSeatStatus(r, c)} className={`relative w-full h-full p-1 rounded border-b-4 transition-all flex flex-col items-center justify-center shadow-lg select-none ${!seat.number ? 'bg-slate-700 border-slate-900 opacity-30' : ''} ${seat.number && !isAbsent && !isDuplicate ? 'bg-slate-100 border-slate-300 text-slate-900 hover:bg-white cursor-pointer' : ''} ${isDuplicate ? 'bg-red-100 border-red-500 text-red-900 ring-2 ring-red-500' : ''} ${isAbsent ? 'bg-red-500 border-red-700 text-white hover:bg-red-400 cursor-pointer' : ''}`}>
                                                    {mode === 'edit' ? (
                                                        <input ref={el => inputRefs.current[key] = el} type="text" className={`w-full text-center bg-transparent outline-none font-bold text-3xl md:text-5xl border-b border-gray-400/50 focus:border-blue-500 p-0 select-text ${isDuplicate ? 'text-red-600 border-red-400' : 'text-inherit'}`} value={seat.number} onChange={(e) => updateSeatNumber(r, c, e.target.value)} onKeyDown={(e) => handleKeyDown(e, r, c)} />
                                                    ) : (
                                                        <div className="text-3xl md:text-6xl font-black tracking-tighter leading-none">{seat.number}</div>
                                                    )}
                                                    {seat.number && (
                                                        <div className={`text-sm md:text-xl font-bold truncate w-full text-center px-0.5 leading-tight mt-1 ${isAbsent ? 'text-red-100' : isDuplicate ? 'text-red-600' : 'text-slate-600'}`}>{studentName || (mode === 'edit' ? '' : '')}</div>
                                                    )}
                                                    
                                                    {/* ç¼ºè€ƒåŸå› é¸å–® (åƒ…åœ¨ç›£è€ƒæ¨¡å¼ä¸”ç¼ºè€ƒæ™‚é¡¯ç¤º) */}
                                                    {isAbsent && mode === 'view' && (
                                                        <div className="absolute top-1 right-1 z-20" onClick={(e) => e.stopPropagation()}>
                                                            <select 
                                                                className="reason-select"
                                                                value={seat.reason || 'ç¼ºè€ƒ'}
                                                                onChange={(e) => updateSeatReason(r, c, e.target.value)}
                                                            >
                                                                {ABSENCE_REASONS.map(reason => (
                                                                    <option key={reason} value={reason} className="text-black bg-white">{reason}</option>
                                                                ))}
                                                            </select>
                                                        </div>
                                                    )}
                                                    
                                                    {isDuplicate && mode === 'edit' && <div className="absolute top-1 right-1 bg-yellow-400 text-red-900 text-[10px] font-bold px-1 rounded shadow z-10 animate-pulse">é‡è¤‡!</div>}
                                                </div>
                                            );
                                        })
                                    ))}
                                </div>
                            </div>
                        </div>

                        {/* Right Section */}
                        <div className="w-96 flex flex-col gap-4 shrink-0 h-full">
                            <div className="bg-amber-50 rounded-xl flex-1 p-4 pixel-border flex flex-col text-slate-800 overflow-hidden border-4 border-gray-700">
                                <h3 className="font-bold text-xl border-b-4 border-amber-200 pb-2 mb-3 flex items-center gap-2 text-amber-800 shrink-0"><Icon name="calendar" size={24} /> ä»Šæ—¥è€ƒç¨‹</h3>
                                <div className="flex-1 overflow-y-auto overflow-x-hidden space-y-2 pr-1 custom-scrollbar">
                                    {schedule.map((item, idx) => {
                                        const active = isCurrentSubject(item.time);
                                        return (
                                            <div key={idx} className={`p-4 rounded-lg border-2 flex justify-between items-center transition-all ${active ? 'bg-yellow-200 border-yellow-400 scale-105 shadow-md' : 'bg-white border-amber-100 text-gray-500'}`}>
                                                {mode === 'edit' ? (
                                                    <div className="flex gap-1 w-full items-center">
                                                        <input className="w-24 text-base bg-gray-50 border rounded px-1 py-1 select-text font-bold" value={item.time} onChange={(e) => {const n=[...schedule];n[idx].time=e.target.value;setSchedule(n)}} />
                                                        <input className="flex-1 text-base bg-gray-50 border rounded px-1 py-1 select-text font-bold" value={item.subject} onChange={(e) => {const n=[...schedule];n[idx].subject=e.target.value;setSchedule(n)}} />
                                                        <button onClick={() => handleDeleteSchedule(idx)} className="text-red-400 hover:text-red-600 p-1"><Icon name="trash-2" size={18}/></button>
                                                    </div>
                                                ) : (
                                                    <><span className={`font-mono font-bold text-xl ${active ? 'text-yellow-900' : ''}`}>{item.time}</span><span className={`font-bold text-2xl ${active ? 'text-yellow-900' : ''}`}>{item.subject}</span></>
                                                )}
                                            </div>
                                        );
                                    })}
                                    {mode === 'edit' && <button onClick={() => setSchedule([...schedule, { time: '00:00-00:00', subject: 'ç§‘ç›®' }])} className="w-full py-3 border-2 border-dashed border-gray-300 text-gray-400 rounded hover:bg-gray-50 mt-2 text-lg font-bold"><Icon name="plus" size={24} /></button>}
                                </div>
                            </div>

                            <div className="bg-[#9bbc0f] rounded-xl p-5 pixel-border text-[#0f380f] flex flex-col gap-3 relative border-4 border-gray-700 shrink-0 h-64">
                                <div className="absolute top-2 right-2 text-xs font-bold opacity-50">DMG-01</div>
                                <div className="flex justify-between items-end border-b-2 border-[#0f380f]/30 pb-4 mt-2">
                                    <div className="flex flex-col"><span className="text-sm font-bold mb-1">æ‡‰åˆ° TOTAL</span><span className="text-6xl font-black leading-none">{stats.shouldAttend}</span></div>
                                    <div className="flex flex-col items-end"><span className="text-sm font-bold mb-1">å¯¦åˆ° ACTUAL</span><span className="text-6xl font-black leading-none">{stats.actualAttend}</span></div>
                                </div>
                                <div className="flex-1 overflow-y-auto custom-scrollbar">
                                    <div className="flex items-center gap-2 text-sm font-bold mb-2"><Icon name="user-x" size={18} /><span>ç¼ºè€ƒ ABSENT:</span></div>
                                    <div className="flex flex-wrap content-start gap-x-3 gap-y-1 h-full">
                                        {stats.absentList.length > 0 ? (
                                            stats.absentList.map((student, idx) => (
                                                <span key={idx} className="text-sm font-bold whitespace-nowrap">
                                                    {student.num} {student.text.split(' ')[1]}<span className="text-xs ml-0.5 opacity-80">({student.reason})</span>
                                                </span>
                                            ))
                                        ) : 'ç„¡ (NONE)'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {showSettings && (
                        <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                            <div className="bg-white rounded-xl max-w-2xl w-full p-6 shadow-2xl flex flex-col max-h-[90vh]">
                                <div className="flex justify-between items-center mb-4"><h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2"><Icon name="settings" className="text-gray-600" /> è€ƒå ´èˆ‡è³‡æ–™åº«è¨­å®š</h2><button onClick={() => setShowSettings(false)} className="text-gray-500 hover:text-gray-800">âœ•</button></div>
                                <div className="overflow-y-auto flex-1 space-y-6 pr-2">
                                    <section className="bg-blue-50 p-4 rounded-lg border border-blue-100"><h3 className="font-bold text-blue-800 mb-2 flex items-center gap-2"><Icon name="cloud" className="text-blue-600" /> é›²ç«¯è³‡æ–™åŒæ­¥ (Firebase)</h3>{isFirebaseConfigured ? (<><p className="text-sm text-blue-600 mb-3">è³‡æ–™å°‡è‡ªå‹•å„²å­˜åœ¨æ‚¨çš„ Firebase å¸³è™Ÿä¸‹ã€‚</p><button onClick={saveToCloud} disabled={syncStatus === 'saving'} className="flex-1 bg-blue-600 text-white px-4 py-2 rounded flex items-center justify-center gap-2 hover:bg-blue-700 disabled:opacity-50"><Icon name="cloud-upload" size={18} />{syncStatus === 'saving' ? 'å„²å­˜ä¸­...' : 'æ‰‹å‹•å„²å­˜ç›®å‰è¨­å®š'}</button></>) : <p className="text-sm text-red-600">å°šæœªè¨­å®š Firebase Configã€‚</p>}</section>
                                    <section className="bg-gray-50 p-4 rounded-lg"><h3 className="font-bold text-gray-700 mb-2">A. åº§ä½æ’åˆ—</h3><div className="flex gap-4"><div className="flex flex-col gap-1"><label className="text-sm text-gray-500">åˆ—æ•¸</label><div className="flex items-center gap-2"><button onClick={() => setConfig({...config, rows: Math.max(1, config.rows - 1)})} className="p-1 bg-gray-200 rounded"><Icon name="minus" size={16}/></button><input type="number" className="w-16 text-center border rounded p-1" value={config.rows} onChange={(e) => setConfig({...config, rows: parseInt(e.target.value) || 1})} /><button onClick={() => setConfig({...config, rows: config.rows + 1})} className="p-1 bg-gray-200 rounded"><Icon name="plus" size={16}/></button></div></div><div className="flex flex-col gap-1"><label className="text-sm text-gray-500">è¡Œæ•¸</label><div className="flex items-center gap-2"><button onClick={() => setConfig({...config, cols: Math.max(1, config.cols - 1)})} className="p-1 bg-gray-200 rounded"><Icon name="minus" size={16}/></button><input type="number" className="w-16 text-center border rounded p-1" value={config.cols} onChange={(e) => setConfig({...config, cols: parseInt(e.target.value) || 1})} /><button onClick={() => setConfig({...config, cols: config.cols + 1})} className="p-1 bg-gray-200 rounded"><Icon name="plus" size={16}/></button></div></div></div></section>
                                    <section><h3 className="font-bold text-gray-700 mb-2 border-l-4 border-green-500 pl-2">B. ç­ç´šåå–®</h3><div className="mb-2 space-y-4"><div className="bg-gray-50 p-3 rounded-lg"><label className="text-sm font-bold text-gray-600 block mb-1">æ–¹æ³• 1: Excel è²¼ä¸Š</label><textarea className="w-full h-32 p-3 border rounded font-mono text-sm bg-white focus:ring-2 focus:ring-green-500 outline-none text-gray-800 select-text" placeholder="[åº§è™Ÿ] [å§“å]" value={rosterText} onChange={(e) => setRosterText(e.target.value)} /></div><div className="bg-gray-50 p-3 rounded-lg"><label className="text-sm font-bold text-gray-600 block mb-1 flex items-center gap-1"><Icon name="file-spreadsheet" size={16} /> æ–¹æ³• 2: Google CSV</label><div className="flex gap-2"><input type="text" className="flex-1 border rounded px-3 py-2 text-sm select-text" placeholder="CSV é€£çµ" value={csvUrl} onChange={(e) => setCsvUrl(e.target.value)} /><button onClick={handleCsvImport} className="bg-green-600 text-white px-3 py-2 rounded text-sm whitespace-nowrap hover:bg-green-700">è®€å–</button></div></div></div></section>
                                    <section className="bg-red-50 p-4 rounded-lg border border-red-200 mt-4"><h3 className="font-bold text-red-800 mb-2 flex items-center gap-2"><Icon name="shield-alert" className="text-red-600" /> ç®¡ç†å“¡å°ˆå€</h3><p className="text-sm text-red-700 mb-3">æ­¤æ“ä½œå°‡æ°¸ä¹…åˆªé™¤ç•¶å‰ç­ç´šã€Œ{activeClassroom}ã€çš„æ‰€æœ‰è³‡æ–™ã€‚</p><button onClick={deleteClassroomData} className="w-full bg-red-600 text-white px-4 py-2 rounded flex items-center justify-center gap-2 hover:bg-red-700 font-bold"><Icon name="trash-2" size={18} /> åˆªé™¤æ­¤ç­ç´šè³‡æ–™</button></section>
                                </div>
                                <div className="mt-6 flex justify-between items-center pt-4 border-t"><span className="text-xs text-gray-400">{user ? `ID: ${user.uid.slice(0,8)}...` : 'æœ¬åœ°æ¨¡å¼'}</span><button onClick={() => {saveToCloud(); setShowSettings(false);}} className="px-6 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 shadow-lg">å„²å­˜ä¸¦é—œé–‰</button></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
