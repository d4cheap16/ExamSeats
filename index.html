<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>監考系統 (Exam Monitor)</title>
    
    <!-- 載入 Tailwind CSS (樣式) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 載入 React 和 Babel (核心運算) -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 載入 Lucide Icons (圖示) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- 自定義樣式 -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', monospace; }
        .pixel-border {
            box-shadow: 4px 4px 0px 0px rgba(0,0,0,0.3);
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
        /* 隱藏 number input 的上下箭頭 */
        input[type=number]::-webkit-outer-spin-button,
        input[type=number]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 h-screen w-screen overflow-hidden">
    <div id="root" class="h-full w-full"></div>

    <!-- 主程式邏輯 -->
    <script type="text/babel" data-type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, doc, setDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        // ==========================================
        // ▼ 您的 Firebase Config ▼
        // ==========================================
        const firebaseConfig = {
          apiKey: "AIzaSyBd1OUQ2wwEOSIezzhsuuYcjZSXJPn-WnI",
          authDomain: "examseat-508e9.firebaseapp.com",
          projectId: "examseat-508e9",
          storageBucket: "examseat-508e9.firebasestorage.app",
          messagingSenderId: "959964513566",
          appId: "1:959964513566:web:88dac9c40c5993a90a750f"
        };
        // ==========================================

        const isFirebaseConfigured = firebaseConfig.apiKey && firebaseConfig.projectId;
        let app, auth, db;
        if (isFirebaseConfigured) {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        }

        const { useState, useEffect, useRef } = React;

        const Icon = ({ name, size = 24, className = "" }) => {
            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
            }, [name]);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        const DEFAULT_SCHEDULE = [
            { time: '08:10-09:20', subject: '數學乙' },
            { time: '09:35-10:35', subject: '自習' },
            { time: '10:50-12:00', subject: '歷史' },
            { time: '13:20-14:30', subject: '地理' },
            { time: '14:45-15:45', subject: '自習' },
            { time: '16:00-17:10', subject: '公民' },
        ];

        const DEFAULT_ROSTER = `1\t周恩佑\n2\t林宏燁\n3\t林恩成\n4\t林晉葳\n5\t林梓軒\n6\t金少澤\n7\t梁家恩\n8\t梁靖昌\n9\t許子寬\n10\t陳卓\n11\t陳藝文\n12\t彭凱毅\n13\t楊閎驛\n14\t劉亭頡\n15\t潘育哲\n16\t溫雁晴\n17\t王苡恩\n18\t王詮儀\n19\t古妮鑫\n20\t向映柔\n21\t朱洧甄\n22\t吳思諭\n23\t吳禹萱\n24\t吳珮妤\n25\t李詠欣\n26\t李芯瑀\n27\t林伽璇\n28\t林瞳\n29\t胡格瑄\n30\t張沛文\n31\t徐芷芸\n32\t曾若庭\n33\t童宇岑\n34\t黃心瑀\n35\t楊采鑫\n36\t楊品歆\n37\t黎容瑄\n38\t藍梓瑜\n39\t林芳仔\n40\t蔣佩芸\n41\t魏瑜廷`;

        const App = () => {
            const [user, setUser] = useState(null);
            const [syncStatus, setSyncStatus] = useState('idle');
            const [currentTime, setCurrentTime] = useState(new Date());
            const [mode, setMode] = useState('edit');
            const [config, setConfig] = useState({ rows: 5, cols: 7, title: '2025/4/24 THU', systemTitle: 'SUPER EXAM SYSTEM' });
            const [schedule, setSchedule] = useState(DEFAULT_SCHEDULE);
            const [rosterText, setRosterText] = useState(DEFAULT_ROSTER);
            const [rosterMap, setRosterMap] = useState({});
            const [csvUrl, setCsvUrl] = useState('');
            const [seats, setSeats] = useState({});
            const [showSettings, setShowSettings] = useState(false);
            
            // 用於鍵盤導航的 input refs
            const inputRefs = useRef({});

            // Auth
            useEffect(() => {
                if (!isFirebaseConfigured) {
                    setSyncStatus('not-configured');
                    return;
                }
                signInAnonymously(auth).catch((error) => {
                    console.error("Auth Error", error);
                    setSyncStatus('error');
                });
                const unsubscribe = onAuthStateChanged(auth, setUser);
                return () => unsubscribe();
            }, []);

            // Sync
            useEffect(() => {
                if (!isFirebaseConfigured || !user) {
                    const savedLocal = localStorage.getItem('examMonitorData');
                    if (savedLocal) {
                        try {
                            const parsed = JSON.parse(savedLocal);
                            if (parsed.config) setConfig(prev => ({...prev, ...parsed.config}));
                            if (parsed.schedule) setSchedule(parsed.schedule);
                            if (parsed.rosterText) setRosterText(parsed.rosterText);
                            if (parsed.seats) setSeats(parsed.seats);
                        } catch(e) {}
                    }
                    return;
                }
                setSyncStatus('loading');
                const docRef = doc(db, 'artifacts', 'exam-monitor-standalone', 'users', user.uid, 'data', 'setup');
                const unsubscribe = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (data.config) setConfig(prev => ({...prev, ...data.config}));
                        if (data.schedule) setSchedule(data.schedule);
                        if (data.rosterText) setRosterText(data.rosterText);
                        if (data.seats) setSeats(data.seats);
                        if (data.csvUrl) setCsvUrl(data.csvUrl);
                        setSyncStatus('idle');
                    } else {
                        const savedLocal = localStorage.getItem('examMonitorData');
                        if (savedLocal) {
                            try {
                                const parsed = JSON.parse(savedLocal);
                                setConfig(prev => ({...prev, ...(parsed.config || {})}));
                                setSchedule(prev => parsed.schedule || prev);
                                setRosterText(prev => parsed.rosterText || prev);
                                setSeats(prev => parsed.seats || prev);
                            } catch(e){}
                        }
                        setSyncStatus('idle');
                    }
                }, (error) => {
                    console.error("Sync error", error);
                    setSyncStatus('error');
                });
                return () => unsubscribe();
            }, [user]);

            useEffect(() => {
                const lines = rosterText.split('\n');
                const newMap = {};
                lines.forEach(line => {
                    const parts = line.trim().split(/[\t,，\s]+/);
                    if (parts.length >= 2) newMap[parts[0]] = parts[1];
                });
                setRosterMap(newMap);
            }, [rosterText]);

            useEffect(() => {
                const timer = setInterval(() => setCurrentTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);

            const saveToCloud = async () => {
                localStorage.setItem('examMonitorData', JSON.stringify({ config, schedule, rosterText, seats }));
                if (!isFirebaseConfigured || !user) {
                    alert('已儲存至本地 (未設定 Firebase)');
                    return;
                }
                setSyncStatus('saving');
                try {
                    const docRef = doc(db, 'artifacts', 'exam-monitor-standalone', 'users', user.uid, 'data', 'setup');
                    await setDoc(docRef, {
                        config, schedule, rosterText, seats, csvUrl,
                        lastUpdated: new Date().toISOString()
                    });
                    setSyncStatus('saved');
                    setTimeout(() => setSyncStatus('idle'), 2000);
                } catch (e) {
                    console.error(e);
                    setSyncStatus('error');
                    alert('雲端儲存失敗，已存至本地');
                }
            };

            const handleCsvImport = async () => {
                if (!csvUrl) return;
                try {
                    setSyncStatus('loading');
                    const response = await fetch(csvUrl);
                    const text = await response.text();
                    setRosterText(text);
                    setSyncStatus('idle');
                    alert('匯入成功！');
                } catch (e) {
                    alert('匯入失敗，請確認網址正確且公開。');
                    setSyncStatus('error');
                }
            };

            const toggleFullScreen = () => {
                if (!document.fullscreenElement) document.documentElement.requestFullscreen();
                else if (document.exitFullscreen) document.exitFullscreen();
            };

            const isCurrentSubject = (timeRange) => {
                const now = new Date();
                const currentMinutes = now.getHours() * 60 + now.getMinutes();
                const [start, end] = timeRange.split('-');
                if (!start || !end) return false;
                const [startH, startM] = start.split(':').map(Number);
                const [endH, endM] = end.split(':').map(Number);
                return currentMinutes >= (startH * 60 + startM) && currentMinutes <= (endH * 60 + endM);
            };

            const stats = (() => {
                let shouldAttend = 0, actualAttend = 0, absentList = [];
                Object.values(seats).forEach(seat => {
                    if (seat.number) {
                        shouldAttend++;
                        if (seat.status !== 'absent') actualAttend++;
                        else absentList.push(rosterMap[seat.number] || `座號${seat.number}`);
                    }
                });
                return { shouldAttend, actualAttend, absentList };
            })();

            const updateSeatNumber = (r, c, val) => {
                const key = `${r}-${c}`;
                setSeats(prev => ({ ...prev, [key]: { ...prev[key], number: val, status: val ? 'present' : 'empty' } }));
            };

            const toggleSeatStatus = (r, c) => {
                const key = `${r}-${c}`;
                const current = seats[key];
                if (!current || !current.number) return;
                const newStatus = current.status === 'present' ? 'absent' : 'present';
                setSeats(prev => ({ ...prev, [key]: { ...current, status: newStatus } }));
            };

            const handleDeleteSchedule = (idx) => {
                if (window.confirm('確定要刪除這個考程嗎？')) {
                    setSchedule(schedule.filter((_, i) => i !== idx));
                }
            };

            // 鍵盤導航處理
            const handleKeyDown = (e, r, c) => {
                let targetR = r;
                let targetC = c;

                if (e.key === 'ArrowUp') targetR = Math.max(0, r - 1);
                else if (e.key === 'ArrowDown') targetR = Math.min(config.rows - 1, r + 1);
                else if (e.key === 'ArrowLeft') targetC = Math.max(0, c - 1);
                else if (e.key === 'ArrowRight') targetC = Math.min(config.cols - 1, c + 1);
                else return; // 不是方向鍵就不處理

                const targetKey = `${targetR}-${targetC}`;
                if (inputRefs.current[targetKey]) {
                    e.preventDefault();
                    inputRefs.current[targetKey].focus();
                }
            };

            return (
                <div className="h-screen w-screen flex flex-col bg-slate-900 text-slate-100 overflow-hidden font-mono select-none">
                    
                    {/* 頂部導覽列 (固定高度) */}
                    <div className="shrink-0 w-full bg-gray-300 text-gray-800 p-2 flex justify-between items-center border-b-4 border-gray-400 shadow-lg z-20 relative">
                        <div className="flex items-center gap-4">
                            <div className="flex gap-1 ml-2">
                                <div className="w-3 h-3 rounded-full bg-red-500 animate-pulse"></div>
                                <div className="w-3 h-3 rounded-full bg-yellow-500"></div>
                                <div className="w-3 h-3 rounded-full bg-green-500"></div>
                            </div>
                            
                            {mode === 'edit' ? (
                                <input 
                                    type="text" 
                                    className="font-black text-xl tracking-widest text-gray-700 bg-transparent border-b-2 border-gray-500 outline-none hidden md:block placeholder-gray-400 w-64"
                                    value={config.systemTitle || ''}
                                    placeholder="請輸入班級名稱"
                                    onChange={(e) => setConfig({...config, systemTitle: e.target.value})}
                                />
                            ) : (
                                <span className="font-black text-xl tracking-widest text-gray-600 hidden md:block">
                                    {config.systemTitle || 'SUPER EXAM SYSTEM'}
                                </span>
                            )}
                            
                            <div className="flex items-center gap-2 px-3 py-1 bg-gray-200 rounded-full border-inner shadow-inner">
                                {syncStatus === 'loading' ? <Icon name="refresh-cw" className="animate-spin text-blue-500" size={14} /> :
                                 syncStatus === 'saving' ? <Icon name="cloud-upload" className="animate-bounce text-blue-500" size={14} /> :
                                 syncStatus === 'saved' ? <Icon name="cloud" className="text-green-600" size={14} /> :
                                 syncStatus === 'error' ? <Icon name="cloud-off" className="text-red-500" size={14} /> :
                                 syncStatus === 'not-configured' ? <Icon name="alert-circle" className="text-orange-500" size={14} /> :
                                 <Icon name="cloud" className="text-gray-400" size={14} />}
                                <span className="text-xs font-bold text-gray-500">
                                    {syncStatus === 'loading' ? '讀取...' : 
                                     syncStatus === 'saving' ? '儲存...' :
                                     syncStatus === 'saved' ? '已同步' :
                                     syncStatus === 'error' ? '同步失敗' : 
                                     syncStatus === 'not-configured' ? '未設定' : '就緒'}
                                </span>
                            </div>
                        </div>
                        
                        <div className="flex gap-2">
                            <button onClick={() => setMode(mode === 'edit' ? 'view' : 'edit')} className={`px-3 py-1.5 rounded-lg font-bold border-b-4 active:border-b-0 active:translate-y-1 transition-all flex items-center gap-2 text-sm ${mode === 'edit' ? 'bg-yellow-400 border-yellow-600 text-yellow-900' : 'bg-blue-400 border-blue-600 text-white'}`}>
                                <Icon name={mode === 'edit' ? 'settings' : 'monitor'} size={16} />
                                {mode === 'edit' ? '編輯' : '監考'}
                            </button>
                            <button onClick={toggleFullScreen} className="px-3 py-1.5 bg-gray-700 text-white rounded-lg font-bold border-b-4 border-gray-900 active:border-b-0 active:translate-y-1 transition-all flex items-center gap-2 text-sm">
                                <Icon name="maximize" size={16} /> 全螢幕
                            </button>
                            <button onClick={() => setShowSettings(true)} className="px-3 py-1.5 bg-gray-200 text-gray-600 rounded-lg border-b-4 border-gray-400 hover:bg-white active:border-b-0 active:translate-y-1 flex items-center gap-1 text-sm">
                                <Icon name="settings" size={16} /> 設定
                            </button>
                        </div>
                    </div>

                    {/* 主畫面區域 (Flex-1 填滿剩餘高度) */}
                    <div className="flex-1 flex w-full overflow-hidden relative p-4 gap-4">
                        
                        {/* 左側：座位表 + 講台 + 時鐘 */}
                        <div className="flex-1 bg-slate-800 rounded-xl p-2 md:p-4 pixel-border relative flex flex-col border-4 border-gray-700 overflow-hidden">
                            
                            {/* 頂部區域：講台與時鐘並列 */}
                            <div className="w-full flex justify-center items-stretch gap-4 mb-2 shrink-0 h-24">
                                
                                {/* 講台 */}
                                <div className="flex-[2] bg-amber-700 text-amber-100 rounded-lg border-b-8 border-amber-900 shadow-lg flex flex-col items-center justify-center relative overflow-hidden group">
                                    <div className="absolute top-1 left-2 opacity-30"><Icon name="monitor" size={32}/></div>
                                    <div className="text-xs md:text-sm opacity-75">TEACHER / PODIUM</div>
                                    <div className="font-bold text-2xl md:text-3xl tracking-widest">講 台</div>
                                </div>

                                {/* 時鐘 (從右側移來) */}
                                <div className="flex-[3] bg-indigo-900 rounded-lg border-b-8 border-indigo-950 shadow-lg flex flex-col items-center justify-center text-white relative overflow-hidden border border-indigo-700">
                                    <div className="absolute inset-0 bg-gradient-to-b from-transparent via-white/5 to-transparent opacity-20 pointer-events-none" style={{backgroundSize: '100% 4px'}}></div>
                                    
                                    {/* 日期標題 */}
                                    {mode === 'edit' ? 
                                        <input className="bg-indigo-800/50 text-center w-3/4 mb-1 rounded p-0.5 text-sm outline-none border border-indigo-500 text-indigo-200" value={config.title} onChange={(e) => setConfig({...config, title: e.target.value})} /> 
                                        : <div className="text-sm md:text-base font-bold text-indigo-300 mb-0">{config.title}</div>}
                                    
                                    {/* 大時間 */}
                                    <div className="text-4xl md:text-5xl font-black tabular-nums tracking-tight text-cyan-300 drop-shadow-[0_0_10px_rgba(103,232,249,0.5)] leading-none">
                                        {currentTime.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false })}
                                    </div>
                                    
                                    {/* 秒條 */}
                                    <div className="w-3/4 h-1 bg-gray-700 mt-2 rounded-full overflow-hidden opacity-50">
                                        <div className="h-full bg-cyan-400 transition-all duration-1000 ease-linear" style={{ width: `${(currentTime.getSeconds() / 60) * 100}%` }}></div>
                                    </div>
                                </div>
                            </div>
                            
                            {/* 裝飾門 */}
                            <div className="absolute top-4 left-2 opacity-30 flex flex-col items-center scale-75 origin-top-left"><Icon name="door-open" size={40} className="text-emerald-500" /><span className="text-xs text-emerald-500">前門</span></div>
                            <div className="absolute top-4 right-2 opacity-30 flex flex-col items-center scale-75 origin-top-right"><Icon name="door-open" size={40} className="text-emerald-500" /><span className="text-xs text-emerald-500">後門</span></div>

                            {/* 座位網格 (可捲動區域) */}
                            <div className="flex-1 overflow-auto flex items-start justify-center pt-2 pb-10 px-2 custom-scrollbar w-full">
                                <div className="grid gap-2 md:gap-3 transition-all" style={{ gridTemplateColumns: `repeat(${config.cols}, minmax(70px, 1fr))`, width: 'fit-content', maxWidth: '100%' }}>
                                    {Array.from({ length: config.rows }).map((_, r) => (
                                        Array.from({ length: config.cols }).map((_, c) => {
                                            const key = `${r}-${c}`;
                                            const seat = seats[key] || { number: '', status: 'empty' };
                                            const studentName = rosterMap[seat.number] || '';
                                            const isAbsent = seat.status === 'absent';

                                            return (
                                                <div key={key} onClick={() => mode === 'view' && toggleSeatStatus(r, c)}
                                                    className={`relative aspect-[4/3] min-w-[70px] min-h-[60px] p-1 rounded border-b-4 transition-all flex flex-col items-center justify-center shadow-lg select-none
                                                    ${!seat.number ? 'bg-slate-700 border-slate-900 opacity-30' : ''} 
                                                    ${seat.number && !isAbsent ? 'bg-slate-100 border-slate-300 text-slate-900 hover:bg-white cursor-pointer' : ''}
                                                    ${isAbsent ? 'bg-red-500 border-red-700 text-white hover:bg-red-400 cursor-pointer' : ''}`}>
                                                    {mode === 'edit' ? (
                                                        <input 
                                                            ref={el => inputRefs.current[key] = el}
                                                            type="text" 
                                                            className="w-full text-center bg-transparent outline-none font-bold text-xl border-b border-gray-400/50 focus:border-blue-500 text-inherit p-0"
                                                            placeholder="-" 
                                                            value={seat.number} 
                                                            onChange={(e) => updateSeatNumber(r, c, e.target.value)}
                                                            onKeyDown={(e) => handleKeyDown(e, r, c)}
                                                        />
                                                    ) : (
                                                        <div className="text-2xl md:text-4xl font-black tracking-tighter leading-none mb-1">{seat.number}</div>
                                                    )}
                                                    {seat.number && <div className={`text-xs font-bold truncate w-full text-center px-0.5 leading-tight ${isAbsent ? 'text-red-100' : 'text-slate-600'}`}>{studentName || (mode === 'edit' ? '查無此人' : '')}</div>}
                                                    {isAbsent && <div className="absolute -top-2 -right-2 bg-red-600 text-white text-[10px] px-1 rounded shadow animate-bounce z-10">缺考</div>}
                                                </div>
                                            );
                                        })
                                    ))}
                                </div>
                            </div>
                        </div>

                        {/* 右側：資訊欄 (剩餘空間) */}
                        <div className="w-80 flex flex-col gap-4 shrink-0 h-full">
                            
                            {/* 考程表 (佔據大部分高度) */}
                            <div className="bg-amber-50 rounded-xl flex-1 p-4 pixel-border flex flex-col text-slate-800 overflow-hidden border-4 border-gray-700">
                                <h3 className="font-bold text-lg border-b-4 border-amber-200 pb-2 mb-3 flex items-center gap-2 text-amber-800 shrink-0"><Icon name="calendar" size={20} /> 今日考程</h3>
                                <div className="flex-1 overflow-y-auto space-y-2 pr-1 custom-scrollbar">
                                    {schedule.map((item, idx) => {
                                        const active = isCurrentSubject(item.time);
                                        return (
                                            <div key={idx} className={`p-3 rounded-lg border-2 flex justify-between items-center transition-all ${active ? 'bg-yellow-200 border-yellow-400 scale-105 shadow-md' : 'bg-white border-amber-100 text-gray-500'}`}>
                                                {mode === 'edit' ? (
                                                    <div className="flex gap-1 w-full items-center">
                                                        <input className="w-20 text-xs bg-gray-50 border rounded px-1 py-1" value={item.time} onChange={(e) => {const n=[...schedule];n[idx].time=e.target.value;setSchedule(n)}} />
                                                        <input className="flex-1 text-xs bg-gray-50 border rounded px-1 py-1" value={item.subject} onChange={(e) => {const n=[...schedule];n[idx].subject=e.target.value;setSchedule(n)}} />
                                                        <button onClick={() => handleDeleteSchedule(idx)} className="text-red-400 hover:text-red-600 p-1"><Icon name="trash-2" size={14}/></button>
                                                    </div>
                                                ) : (
                                                    <><span className={`font-mono font-bold text-sm ${active ? 'text-yellow-800' : ''}`}>{item.time}</span><span className={`font-bold text-lg ${active ? 'text-yellow-900' : ''}`}>{item.subject}</span></>
                                                )}
                                            </div>
                                        );
                                    })}
                                    {mode === 'edit' && <button onClick={() => setSchedule([...schedule, { time: '00:00-00:00', subject: '科目' }])} className="w-full py-2 border-2 border-dashed border-gray-300 text-gray-400 rounded hover:bg-gray-50 mt-2"><Icon name="plus" size={20} /></button>}
                                </div>
                            </div>

                            {/* 統計 (固定高度) */}
                            <div className="bg-[#9bbc0f] rounded-xl p-4 pixel-border text-[#0f380f] flex flex-col gap-2 relative border-4 border-gray-700 shrink-0">
                                <div className="absolute top-2 right-2 text-[10px] font-bold opacity-50">DMG-01</div>
                                <div className="flex justify-between items-end border-b border-[#0f380f]/30 pb-2">
                                    <div className="flex flex-col"><span className="text-xs font-bold">應到 TOTAL</span><span className="text-4xl font-black leading-none">{stats.shouldAttend}</span></div>
                                    <div className="flex flex-col items-end"><span className="text-xs font-bold">實到 ACTUAL</span><span className="text-4xl font-black leading-none">{stats.actualAttend}</span></div>
                                </div>
                                <div className="mt-1"><div className="flex items-center gap-1 text-xs font-bold mb-1"><Icon name="user-x" size={14} /><span>缺考 ABSENT:</span></div><div className="text-sm font-bold leading-tight min-h-[1.5em]">{stats.absentList.length > 0 ? stats.absentList.join('、') : '無 (NONE)'}</div></div>
                            </div>
                        </div>
                    </div>

                    {/* 設定視窗 */}
                    {showSettings && (
                        <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                            <div className="bg-white rounded-xl max-w-2xl w-full p-6 shadow-2xl flex flex-col max-h-[90vh]">
                                <div className="flex justify-between items-center mb-4"><h2 className="text-2xl font-bold text-gray-800 flex items-center gap-2"><Icon name="settings" className="text-gray-600" /> 考場與資料庫設定</h2><button onClick={() => setShowSettings(false)} className="text-gray-500 hover:text-gray-800">✕</button></div>
                                <div className="overflow-y-auto flex-1 space-y-6 pr-2">
                                    <section className="bg-blue-50 p-4 rounded-lg border border-blue-100">
                                        <h3 className="font-bold text-blue-800 mb-2 flex items-center gap-2"><Icon name="cloud" className="text-blue-600" /> 雲端資料同步 (Firebase)</h3>
                                        {isFirebaseConfigured ? (
                                            <>
                                                <p className="text-sm text-blue-600 mb-3">資料將自動儲存在您的 Firebase 帳號下。</p>
                                                <button onClick={saveToCloud} disabled={syncStatus === 'saving'} className="flex-1 bg-blue-600 text-white px-4 py-2 rounded flex items-center justify-center gap-2 hover:bg-blue-700 disabled:opacity-50"><Icon name="cloud-upload" size={18} />{syncStatus === 'saving' ? '儲存中...' : '手動儲存目前設定'}</button>
                                            </>
                                        ) : <p className="text-sm text-red-600">尚未設定 Firebase Config。</p>}
                                    </section>
                                    <section>
                                        <h3 className="font-bold text-gray-700 mb-2 border-l-4 border-gray-500 pl-2">A. 座位排列</h3>
                                        <div className="flex gap-4 items-center bg-gray-50 p-4 rounded-lg">
                                            <div className="flex flex-col gap-1"><label className="text-sm text-gray-500">列數</label><div className="flex items-center gap-2"><button onClick={() => setConfig({...config, rows: Math.max(1, config.rows - 1)})} className="p-1 bg-gray-200 rounded"><Icon name="minus" size={16}/></button><input type="number" className="w-16 text-center font-bold text-gray-800 border rounded p-1" value={config.rows} onChange={(e) => setConfig({...config, rows: parseInt(e.target.value) || 1})} /><button onClick={() => setConfig({...config, rows: config.rows + 1})} className="p-1 bg-gray-200 rounded"><Icon name="plus" size={16}/></button></div></div>
                                            <span className="text-gray-400 text-xl">×</span>
                                            <div className="flex flex-col gap-1"><label className="text-sm text-gray-500">行數</label><div className="flex items-center gap-2"><button onClick={() => setConfig({...config, cols: Math.max(1, config.cols - 1)})} className="p-1 bg-gray-200 rounded"><Icon name="minus" size={16}/></button><input type="number" className="w-16 text-center font-bold text-gray-800 border rounded p-1" value={config.cols} onChange={(e) => setConfig({...config, cols: parseInt(e.target.value) || 1})} /><button onClick={() => setConfig({...config, cols: config.cols + 1})} className="p-1 bg-gray-200 rounded"><Icon name="plus" size={16}/></button></div></div>
                                        </div>
                                    </section>
                                    <section>
                                        <h3 className="font-bold text-gray-700 mb-2 border-l-4 border-green-500 pl-2">B. 班級名單</h3>
                                        <div className="mb-2 space-y-4">
                                            <div className="bg-gray-50 p-3 rounded-lg"><label className="text-sm font-bold text-gray-600 block mb-1">方法 1: Excel 貼上</label><textarea className="w-full h-32 p-3 border rounded font-mono text-sm bg-white focus:ring-2 focus:ring-green-500 outline-none text-gray-800" placeholder="[座號] [姓名]" value={rosterText} onChange={(e) => setRosterText(e.target.value)} /></div>
                                            <div className="bg-gray-50 p-3 rounded-lg"><label className="text-sm font-bold text-gray-600 block mb-1 flex items-center gap-1"><Icon name="file-spreadsheet" size={16} /> 方法 2: Google CSV</label><div className="flex gap-2"><input type="text" className="flex-1 border rounded px-3 py-2 text-sm" placeholder="CSV 連結" value={csvUrl} onChange={(e) => setCsvUrl(e.target.value)} /><button onClick={handleCsvImport} className="bg-green-600 text-white px-3 py-2 rounded text-sm whitespace-nowrap hover:bg-green-700">讀取</button></div></div>
                                        </div>
                                    </section>
                                </div>
                                <div className="mt-6 flex justify-between items-center pt-4 border-t"><span className="text-xs text-gray-400">{user ? `ID: ${user.uid.slice(0,8)}...` : '本地模式'}</span><button onClick={() => {saveToCloud(); setShowSettings(false);}} className="px-6 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 shadow-lg">儲存並關閉</button></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
